<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Bone Density Monitor</title>
    <link rel="stylesheet" href="/css/style.css" type="text/css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<nav class="navbar">
    <div class="nav-container">
        <a href="/" class="nav-logo">
            <span class="logo-icon">ü¶¥</span>
            <span class="logo-text">BoneDensity</span>
        </a>
        <ul class="nav-menu">
            <li><a href="/" class="nav-link">Home</a></li>
            <li><a href="/dashboard" class="nav-link active">Dashboard</a></li>
            <li><a href="/about" class="nav-link">About</a></li>
        </ul>
    </div>
</nav>

<div class="dashboard-container">
    <div class="dashboard-header animate-fade-in">
        <h1>Bone Health Dashboard</h1>
        <p class="user-id">User: <span th:text="${userId}">user001</span></p>
    </div>

    <!-- Top Metrics Grid -->
    <div class="metrics-grid">
        <!-- Current Reading Card -->
        <div class="metric-card metric-primary animate-slide-up" style="animation-delay: 0.1s;">
            <div class="metric-icon">üìä</div>
            <div class="metric-content">
                <p class="metric-label">Current Bone Density</p>
                <h2 class="metric-value">
                    <span class="counter-animation" th:attr="data-target=${latestReading.density}" th:text="${#numbers.formatDecimal(latestReading.density, 1, 2)}">1.15</span>
                    <span class="metric-unit">g/cm¬≤</span>
                </h2>
                <p class="metric-time">Last updated: <span th:text="${#temporals.format(latestReading.timestamp, 'MMM dd, HH:mm')}">Nov 24, 14:30</span></p>
            </div>
            <div class="metric-badge" th:classappend="${latestReading.healthStatus.toLowerCase()}">
                <span th:text="${latestReading.healthStatus}">Healthy</span>
            </div>
        </div>

        <!-- Acoustic Impedance Card -->
        <div class="metric-card animate-slide-up" style="animation-delay: 0.2s;">
            <div class="metric-icon">üîä</div>
            <div class="metric-content">
                <p class="metric-label">Acoustic Impedance</p>
                <h2 class="metric-value">
                    <span class="counter-animation" th:attr="data-target=${latestReading.acousticImpedance}" th:text="${#numbers.formatDecimal(latestReading.acousticImpedance, 1, 1)}">3.2</span>
                    <span class="metric-unit">MRayl</span>
                </h2>
                <p class="metric-subtitle">Bone material properties</p>
            </div>
        </div>

        <!-- Health Score Card -->
        <div class="metric-card animate-slide-up" style="animation-delay: 0.3s;">
            <div class="metric-icon">üéØ</div>
            <div class="metric-content">
                <p class="metric-label">Bone Health Score</p>
                <h2 class="metric-value">
                    <span class="counter-animation" th:attr="data-target=${(latestReading.density / 1.5) * 100}" th:text="${#numbers.formatDecimal((latestReading.density / 1.5) * 100, 1, 0)}">77</span>
                    <span class="metric-unit">%</span>
                </h2>
                <div class="progress-bar">
                    <div class="progress-fill" th:style="'width: ' + ${(latestReading.density / 1.5) * 100} + '%'"></div>
                </div>
            </div>
        </div>

        <!-- Health Status Guide Card -->
        <div class="metric-card animate-slide-up" style="animation-delay: 0.35s;">
            <div class="metric-icon">üíä</div>
            <div class="metric-content">
                <p class="metric-label">Health Status Guide</p>
                <div class="status-guide-compact">
                    <div class="status-item-compact">
                        <span class="status-dot-compact healthy"></span>
                        <span>Healthy (‚â•1.0)</span>
                    </div>
                    <div class="status-item-compact">
                        <span class="status-dot-compact warning"></span>
                        <span>Warning (0.8-1.0)</span>
                    </div>
                    <div class="status-item-compact">
                        <span class="status-dot-compact concerning"></span>
                        <span>Concerning (<0.8)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="dashboard-card chart-card animate-scale-up" style="animation-delay: 0.4s;">
        <h2>üìà Bone Density Trend</h2>
        <canvas id="densityChart"></canvas>
    </div>

    <!-- Recent Readings Table -->
    <div class="dashboard-card recent-readings animate-fade-in" style="animation-delay: 0.5s;">
        <h2>üìã Recent Readings</h2>
        <div class="table-container">
            <table class="readings-table">
                <thead>
                <tr>
                    <th>Date & Time</th>
                    <th>Bone Density (g/cm¬≤)</th>
                    <th>Acoustic Impedance (MRayl)</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="reading, iterStat : ${readings}" class="table-row-animate" th:style="'animation-delay: ' + ${0.6 + iterStat.index * 0.1} + 's'">
                    <td th:text="${#temporals.format(reading.timestamp, 'MMM dd, yyyy HH:mm')}">Nov 24, 2025 14:30</td>
                    <td th:text="${#numbers.formatDecimal(reading.density, 1, 2)}">1.15</td>
                    <td th:text="${#numbers.formatDecimal(reading.acousticImpedance, 1, 1)}">3.2</td>
                    <td>
                        <span class="table-status" th:classappend="${reading.healthStatus.toLowerCase()}" th:text="${reading.healthStatus}">Healthy</span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Device Info -->
    <div class="dashboard-card device-info animate-fade-in" style="animation-delay: 0.7s;">
        <h2>‚öôÔ∏è Device Information</h2>
        <div class="info-grid">
            <div class="info-item hover-lift">
                <span class="info-label">Device:</span>
                <span class="info-value">ESP32 S3 DevKitC</span>
            </div>
            <div class="info-item hover-lift">
                <span class="info-label">Sensor:</span>
                <span class="info-value">Piezoelectric Film</span>
            </div>
            <div class="info-item hover-lift">
                <span class="info-label">Vibration Motor:</span>
                <span class="info-value">DC 3V 12000rpm</span>
            </div>
            <div class="info-item hover-lift">
                <span class="info-label">Connection:</span>
                <span class="info-value">
                    <span class="connection-indicator">‚óè</span> Bluetooth/WiFi
                </span>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="container">
        <div class="footer-bottom">
            <p>&copy; 2025 Bone Density Monitor. Built for MedTech Hack.</p>
        </div>
    </div>
</footer>

<script th:inline="javascript">
    /*<![CDATA[*/
    function initDashboard(readings) {
        initCounterAnimations();
        if (readings && readings.length > 0) {
            createDensityChart(readings);
        }
    }

    function initCounterAnimations() {
        document.querySelectorAll('.counter-animation').forEach(counter => {
            const target = parseFloat(counter.getAttribute('data-target'));
            const duration = 2000;
            let current = 0;
            const increment = target / (duration / 16);

            const updateCounter = () => {
                current += increment;
                counter.textContent = (current < target)
                    ? current.toFixed(target >= 10 ? 0 : 2)
                    : target.toFixed(target >= 10 ? 0 : 2);
                if (current < target) requestAnimationFrame(updateCounter);
            };

            new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        updateCounter();
                        entry.target.observer?.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.5 }).observe(counter);
        });
    }

    function createDensityChart(readings) {
        const ctx = document.getElementById('densityChart');
        if (!ctx) return;

        const processData = (arr, prop) => arr.map(r => r[prop]).reverse();
        const labels = readings.map(r => new Date(r.timestamp).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})).reverse();

        const createDataset = (label, data, color, yAxisID) => ({
            label, data,
            borderColor: color,
            backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
            borderWidth: 3,
            tension: 0.4,
            fill: true,
            yAxisID,
            pointRadius: 6,
            pointHoverRadius: 8,
            pointBackgroundColor: color,
            pointBorderColor: '#fff',
            pointBorderWidth: 2
        });

        new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    createDataset('Bone Density (g/cm¬≤)', processData(readings, 'density'), '#0077b6', 'y'),
                    createDataset('Acoustic Impedance (MRayl)', processData(readings, 'acousticImpedance'), '#48cae4', 'y1')
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                animation: { duration: 2000, easing: 'easeInOutQuart' },
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { usePointStyle: true, padding: 15, font: { size: 13, weight: 'bold' } }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}`
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: { display: true, text: 'Bone Density (g/cm¬≤)', font: { size: 14, weight: 'bold' } },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' },
                        ticks: { callback: (val) => val.toFixed(2) }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: { display: true, text: 'Acoustic Impedance (MRayl)', font: { size: 14, weight: 'bold' } },
                        grid: { drawOnChartArea: false },
                        ticks: { callback: (val) => val.toFixed(1) }
                    },
                    x: { grid: { color: 'rgba(0, 0, 0, 0.05)' } }
                }
            }
        });
    }

    initDashboard(/*[[${readings}]]*/ []);
    /*]]>*/
</script>
</body>
</html>